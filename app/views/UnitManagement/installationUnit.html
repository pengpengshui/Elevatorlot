
<div class="mainwrap">
	<div class="header"><span>单位管理</span>><span>安装单位管理</span></div>
	<form class="main-choose-list overflowH" id="searchForm">
		<!--搜索-->
		<div class="search-wrap">
			<span class="icon-icon_search" ></span><input type="text" class="form-control" placeholder="请输入关键字"/>
		</div>
		<!--<span class="icon-icon_nav_zhank"></span>-->
		<button type="button" class="btn btn-info " onclick="searchFn(url)">查询</button>
		<!-- Button trigger modal -->
		<button type="button" class="btn btn-default "  id="addModelShow">
		  添加
		</button>
	</form>
	<div class="main">
		<!--表格列表-->
		<table class="table table-striped table-hover table-bordered"  align="center">
			<thead>
				<th>单位名称</th>
				<th>电梯数量</th>
				<th>单位地址</th>
				<th>负责人</th>
				<th>负责人电话</th>
				<th>单位电话</th>
				<th>最后更新人</th>
				<th>最后更新时间</th>
				<th>操作</th>
			</thead>
			<tbody id="tbody">
			</tbody>
		</table>
		<div class="page" >
			<div class="pageWrap">
				<ul class="pagination">
					<li class="Previous">
						<span aria-hidden="true">&laquo;</span>
					</li>
					
					<li class="Next">
						<span aria-hidden="true">&raquo;</span>
					</li>
				</ul>
				<span>共0条数据</span>
			</div>
		</div>
	</div>
</div>


<!-- add弹框 /edit弹框-->
<div class="modal fade" id="addInstallationModel" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content modal-width2">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h5 class="modal-title" id="gridSystemModalLabel">添加安装单位</h5>
      </div>
      <div class="modal-body modelStyle">
      	<form id="addForm">
	        <div class="row">
				  <div class="col-md-12">单位信息</div>
			  </div>
			  <div class="row ">
				  <div class="col-md-2 child"><strong>*</strong>单位名称</div>
				  <div class="col-md-10"><input name="UnitName" class="form-control" type="text" maxlength="50" /></div>
			  </div>
			  <div class="row ">
				  <div class="col-md-2 child"><strong>*</strong>单位地址</div>
				  <div class="col-md-10"><input name="UnitAddress" class="form-control" type="text" maxlength="50" /></div>
			  </div>
			  <div class="row">
				  <div class="col-md-2 child"><strong>*</strong>负责人</div>
				  <div class="col-md-4"><input type="text" class="form-control" name="UnitPrincipal" maxlength="15" /></div>
				  <div class="col-md-2 child"><strong>*</strong>负责人电话</div>
				  <div class="col-md-4"><input type="text" class="form-control" name="UnitPrincipalPhone" /></div>
			  </div>
			  <div class="row">
				  <div class="col-md-12">联系方式</div>
			  </div>
			  <div class="row">
				  <div class="col-md-2 child"><strong>*</strong>单位电话</div>
				  <div class="col-md-4"><input type="text" class="form-control" name="UnitUninPhone" /></div>
				  <div class="col-md-2 child">单位传真</div>
				  <div class="col-md-4"><input type="text" class="form-control" name="UnitFax" /></div>
			 </div>
        </form>
      </div>
      <div class="modal-footer">
      	<label id="prompts"></label>
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-info hide" id="addModelBtn">确定</button>
        <button type="button" class="btn btn-info " id="editModelBtn">修改</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!--view弹框-->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content modal-width">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h5 class="modal-title" id="myModalLabel">查看关联电梯</h5>
      </div>
      <div class="modal-body">
        <table class="table table-striped table-hover table-bordered"  align="center">
			<thead>
				<th>电梯名称</th>
				<th>设备编号</th>
				<th>使用单位</th>
				<th>安装单位</th>
				<th>电梯型号</th>
			</thead>
			<tbody id="tbody1">
				
      	</table>
      </div>
    </div>
  </div>
</div>


<!--确认删除框-->
<div class="modal fade bs-example-modal-sm" id="conformModel" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
	<div class="modal-dialog modal-sm" role="document">
		<div class="modal-content modal-exWidth">
			<div class="modal-body">
				<p><i class="icon-icon_jc_2_on  lightYellow"></i>您确定要删除么？</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default btn-sm comformQiutBtn" data-dismiss="modal">放弃</button>
				<button type="button" class="btn btn-primary btn-sm comformSureBtn">确定</button>
			</div>
		</div>
	</div>
</div>

<!--列表模板-->
<script id="tbodyInfo" type="text/x-handlebars-template">
    {{#each this}}
    <tr>
        <td>{{UnitName}}</td>
        <td><a href="#" onclick="eleCountFun('{{UnitId}}')">{{EleCount}}</a></td>
		<td>{{UnitAddress}}</td>
        <td>{{UnitPrincipal}}</td>
        <td>{{UnitPrincipalPhone}}</td>
        <td>{{UnitUninPhone}}</td>
        <td>{{UnitUpdater}}</td>
        <td>{{UnitUpdateTimeView}}</td>
        <td data-UnitId="{{UnitId}}"><i class="icon-icon_edit" onclick="editIconFun(this)" data-target="#addInstallationModel"></i><i class="icon-icon_delete" onclick="deleteIconFun(this)"></i></td>
    </tr>
    {{/each}}
</script>

<!--电梯数量列表模板-->
<script  id="tbodyInfo1" type="text/x-handlebars-template">
	{{#each this}}
	<tr data-estId="{{EstId}}">
		<td>{{EleJobNo}}</td>
		<td>{{EleDeviceId}}</td>
		<td>{{UseName}}</td>
		<td>{{UnitName}}</td>
		<td>{{EleModel}}</td>
	</tr>
	{{/each}}
</script>

<script>
	/*请求列表地址*/
	var url=configSet+"/api/unitmanage/installunitinfolist?pagesize="+pageSize+"&pagenum=1&inquire=";

	//电梯数量请求地址
	var url2=configSet+"/api/unitmanage/GetEleInfoListByUnitId?unitId=";
	
	$(function () {
      getTableData(url);
    })

	/*数据获取*/
	function getTableData(url) {
      getData(url,function (Obj,pageNum) {
        tableData(Obj,$('#tbody'), $("#tbodyInfo"));
        pageFun(pageNum);
      })
    }

	/*添加数据*/
	$("#addModelShow").click(function () {
		//清空提示框
		$("#prompts").html("");
        $('#addInstallationModel').modal('show');
        $("#addForm")[0].reset();
		toggle("add","#addInstallationModel","添加安装单位")
	})

     //模态框的确定点击事件
    var phoneNum = $("input[name='UnitPrincipalPhone']");
	var fixNum = $("input[name='UnitUninPhone']");
    $("#addModelBtn").click(function () {
		var bol=required(addForm.length-1,addForm);
		if(bol){
			if(!phoneNumber.test(phoneNum.val())){
				$("#prompts").html("负责人电话格式错误!");
				phoneNum.focus();
				return false;
			}
			if(!Landline.test(fixNum.val())){
				$("#prompts").html("单位电话格式错误!");
					fixNum.focus();
					return false;
			}
			$("#prompts").html("");
			var postdata =configSet+ "/api/unitmanage/installunitinfoadd";
			var formse = $("#addForm").serializeObject();
			formse.UnitCreater = loginer;
			postData(postdata, JSON.stringify(formse), function () {
				getTableData(url);
			});
			$('#addInstallationModel').modal('hide');
		}
	})
    
	var unitId
    //删除操作
    function deleteIconFun(obj) {
	   unitId=$(obj).parent().attr("data-UnitId");
		$("#conformModel").modal();
    }
    
    //模态框的删除点击事件。
	$(".comformSureBtn").click(function () {
	  var url1=configSet+"/api/unitmanage/installunitinfoupdelete?unitId="+unitId+"&UnitUpdater="+loginer;
	  getData(url1,function (Obj) {
      	if (Obj === "该单位下已有关联的相机，暂不能删除！") {
      		alert(Obj)
      	}
		getTableData(url);
	  })
	  $("#conformModel").modal("hide");
	})

	//修改操作
	function editIconFun(obj) {
	  unitId=$(obj).parent().attr("data-UnitId");
	  var url1=configSet+"/api/unitmanage/getinstallunitinfobyid?unitId="+unitId;
	  getData(url1,function (Obj) {
		Obj=JSON.parse(Obj);
		var inputs=$("#addForm input[type='text']");
		//清空提示框
		$("#prompts").html("");
		$("#addInstallationModel").modal("show");
		editInput(Obj,inputs,"1");
		//模态框的修改点击事件。
		toggle("edit","#addInstallationModel","修改安装单位信息")
	  })
	}
	
	//模态框的修改点击事件。
    $("#editModelBtn").click(function () {
	    var bol=required(addForm.length-1,addForm)
	    if(bol){
	    	if(!phoneNumber.test(phoneNum.val())){
				$("#prompts").html("负责人电话格式错误!");
				phoneNum.focus();
				return false;
			}
			if(!Landline.test(fixNum.val())){
				$("#prompts").html("单位电话格式错误!");
					fixNum.focus();
					return false;
			}
			$("#prompts").html("");
	    	var posturl=configSet+"/api/unitmanage/installunitinfoupdate";
		    var formse=$("#addForm").serializeObject();
		    formse.unitId=unitId;
		    formse.UnitUpdater=sessionStorage.username;
		    postData(posturl,JSON.stringify(formse),function () {
			  getTableData(url);
		    });
		    $('#addInstallationModel').modal('hide');
	    }
	});
	
	//楼宇数量的点击事件
    function eleCountFun(unitId) {
        var newUrl2=url2 + unitId;
        builder.builderSelected(newUrl2,$("#myModal"),$("#tbody1"),$("#tbodyInfo1"));
    }
    
	//分页
	$(".pagination").on("click","a",function () {
	  var pagenum=parseInt($(this).text());
	  var url2=configSet+"/api/unitmanage/installunitinfolist?pagesize="+pageSize+"&pagenum="+pagenum+"&inquire="+searchValue;
	  getData(url2,function (Obj) {
	    var myTemplate = Handlebars.compile($("#tbodyInfo").html());
	    $('#tbody').html(myTemplate(JSON.parse(Obj)));
	  })
	})
</script>


