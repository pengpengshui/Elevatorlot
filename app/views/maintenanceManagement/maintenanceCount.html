
<div class="mainwrap">
	<div class="header"><span>维保管理</span>><span>维保统计</span></div>
	<!--tab标签栏-->
	<div class="tab-nav">
		<ul class="nav nav-tabs">
		  <li role="presentation" class="active"><a href="#">按电梯统计</a></li>
			<li role="presentation"><a href="#">按维保单位统计</a></li>
		  <li role="presentation"><a href="#">维保日历</a></li>
		</ul>
	</div>
	<!--按钮导航栏-->
	<div class="tabPage">
		<form class="main-choose-list">
			<!--搜索-->
			<div class="search-wrap">
				<span class="icon-icon_search" ></span><input type="text" class="form-control" placeholder="请输入电梯名称"/>
			</div>
			<button type="button" class="btn btn-info" onclick="searchFn(mainInfoUrl)">查询</button>
		</form>
		<div class="main">
			<!--表格列表-->
			<table class="table table-striped table-hover table-bordered"  align="center">
				<thead>
					<th width="44%">电梯名称</th>
					<th width="33%">维保次数</th>
					<th width="33%">最后保养日期</th>
				</thead>
				<tbody id="tbody1">
           		</tbody>
			</table>
			<div class="page tabPages1">
				<div class="pageWrap">
					<ul class="pagination">
						<li class="Previous">
							<span aria-hidden="true">&laquo;</span>
						</li>
						
						<li class="Next">
							<span aria-hidden="true">&raquo;</span>
						</li>
					</ul>
					<span></span>
				</div>
				<button class="icon-icon_daochu btn btn-info pull-right" onclick="exportInfo()">  导出</button>
			</div>
		</div>
	</div>
	<div class="tabPage">
		<form class="main-choose-list form3">
			<select class="form-control" id="maintance2" name="unitId">
				<option value="">维保单位</option>
			</select>
			<select class="form-control" id="maintancePeople2" name="empId">
				<option value="">维保人员</option>
			</select>
			<button type="button" class="btn btn-info" onclick="searchFun3()">查询</button>
		</form>
		<div class="main">
			<!--表格列表-->
			<table class="table table-striped table-hover table-bordered"  align="center">
				<thead>
				<td width="44%">维保单位</th>
				<th width="33%">维保次数</th>
				<th width="33%">维保人员</th>
				</thead>
				<tbody id="tbody3">
				</tbody>
			</table>
			<div class="page tabPages3">
				<div class="pageWrap">
					<ul class="pagination">
						<li class="Previous">
							<span aria-hidden="true">&laquo;</span>
						</li>

						<li class="Next">
							<span aria-hidden="true">&raquo;</span>
						</li>
					</ul>
					<span>共0条数据</span>
				</div>
				<button class="icon-icon_daochu btn btn-info pull-right" onclick="exportInfo2()">  导出</button>
			</div>
		</div>
	</div>
	<div class="tabPage" style="overflow: auto;">
		<form class="main-choose-list" id="calendarSearch">
			<select class="form-control" id="maintance1" name="unitId">
				<option value="">维保单位</option>
			</select>
			<select class="form-control" id="maintancePeople1" name="empId">
				<option value="">维保人员</option>
			</select>
			<button type="button" class="btn btn-info" onclick="calendarSearch()">查询</button>
		</form>
		<div class="main">
			<div id="calendar" style="width: 90%;margin: 0 auto;">

			</div>
		</div>
	</div>
</div>

<!--维保信息维保次数弹框-->
<div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content modal-width">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h5 class="modal-title" id="">维保记录</h5>
			</div>
			<div class="modal-body height450">
				<table class="table table-striped table-hover table-bordered"  align="center">
					<thead>
					<th width="45%">维保单位名称</th>
					<th width="20%">维保人员</th>
					<th width="35%">维保时间</th>
					</thead>
					<tbody id="tbody2">

					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<!--维保单位维保次数弹框-->
<div class="modal fade in" id="myModal4" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content modal-width">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h5 class="modal-title">维保记录</h5>
			</div>
			<div class="modal-body height450">
				<table class="table table-striped table-hover table-bordered"  align="center">
					<thead>
					<th width="20%">电梯名称</th>
					<th width="45%">使用单位</th>
					<th width="35%">维保时间</th>
					</thead>
					<tbody id="tbody4">

					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<!--查看弹框-->
<div class="modal fade" id="myModal3" tabindex="-1" role="dialog" aria-labelledby="myModalLabel2">
  <div class="modal-dialog" role="document">
    <div class="modal-content modal-maxWidth">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		  <h5 class="modal-title" id="myModalLabel">电梯详情</h5>
	  </div>
		<div class="modal-body modelStyle tabStyle2">
			<div class="tab-nav">
				<ul class="nav nav-tabs">
					<li class="active"><a href="#">电梯信息</a></li>
					<li><a href="#">出厂信息</a></li>
					<li><a href="#">安装信息</a></li>
					<li><a href="#">维保信息</a></li>
				</ul>
        	</div>
			<div class="tab_page2">
				<div class="importantInfo col-md-12">
					<div class="title"><span></span>基本信息</div>
					<div class="labelData">
						<div class="col-md-4"><label label-data="EleJobNo">电梯名称:</label><span></span></div>
						<div class="col-md-4"><label label-data="DisAddress">详细地址:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleModel">电梯型号:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleUseStatus">使用状态:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleWeight">额定载重:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleDeviceId">设备编号:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleType">电梯类型:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleFloorCount">层/站/门:</label><span></span></div>
					</div>
				</div>
				<div class="importantInfo col-md-12">
					<div class="title"><span></span>单位信息</div>
					<div class="labelData">
						<div class="col-md-4"><label label-data="UseName">使用单位:</label><span></span></div>
						<div class="col-md-4"><label label-data="ProName">物业单位:</label><span></span></div>
						<div class="col-md-4"><label label-data="UnitName">安装单位:</label><span></span></div>
						<div class="col-md-4"><label label-data="MainName">维保单位:</label><span></span></div>
						<div class="col-md-4"><label label-data="UseName">产权单位:</label><span></span></div>
						<div class="col-md-4"><label label-data="EquName" class="width100">制造厂商名称:</label><span class="width155"></span></div>
					</div>
				</div>
			</div>
			<div class="tab_page2">
				<div class="importantInfo col-md-12">
					<div class="title"><span></span>电梯信息</div>
					<div class="labelData">
						<div class="col-md-4"><label label-data="EleManufactureDate">出厂日期:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleFactoryCode" class="width100">电梯出厂编号:</label><span class="width150"></span></div>
						<div class="col-md-4"><label label-data="EleQualifiedDate">整梯合格证日期:</label><span></span></div>
					</div>
				</div>
				<div class="importantInfo col-md-12">
					<div class="title"><span></span>电梯设备合同信息</div>
					<div class="labelData">
						<div class="col-md-4"><label label-data="EleContractCode" class="width100">电梯设备合同编号:</label><span class="width155"></span></div>
						<div class="col-md-4"><label label-data="EleContractDate" class="width100">电梯设备合同签订日期:</label><span class="width155"></span></div>
					</div>
				</div>
				<div class="importantInfo col-md-12">
					<div class="title"><span></span>楼盘信息</div>
					<div class="labelData">
						<div class="col-md-4"><label label-data="EquName">楼盘名称:</label><span></span></div>
						<div class="col-md-4"><label label-data="UseName">楼盘地址:</label><span></span></div>
					</div>
				</div>
				<div class="importantInfo col-md-12">
					<div class="title"><span></span>制造厂商信息</div>
					<div class="labelData">
						<div class="col-md-4"><label label-data="UseName">制造厂商名称:</label><span></span></div>
						<div class="col-md-4"><label label-data="UseName">电梯设备合同签订日期:</label><span></span></div>
					</div>
				</div>
			</div>
			<div class="tab_page2">
				<div class="importantInfo col-md-12">
					<div class="title"><span></span>安装信息</div>
					<div class="labelData labelStyle1">
						<div class="col-md-4"><label label-data="UnitName">安装单位:</label><span></span></div>
						<div class="col-md-4"><label label-data="ElePlanTime">计划安装工期:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleIntiEndTime">安装结束日期:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleUnitProjectName">安装单位项目负责人:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleUnitProjectPhone">安装单位项目负责人电话:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleTransferTime">电梯移交客户日期:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleDebugPeople">调试人员:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleAcceptTime">验收日期:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleIssuedTime">签发日期:</label><span></span></div>

						<div class="col-md-4"><label label-data="EleBeginTime">三包结束日期:</label><span></span></div>

						<div class="col-md-4"><label label-data="EleInTime">进厂日期:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleDebugTime">调试日期:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleDebugPhone">调试人员电话:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleReviewTime">复检日期:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleUseCode">使用编号:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleBeginTime">三包开始日期:</label><span></span></div>
					</div>
				</div>
				<div class="importantInfo col-md-12">
					<div class="title"><span></span>位置信息</div>
					<div class="labelData">
						<div class="col-md-4"><label label-data=" DisAddress">所在区域:</label><span></span></div>
						<div class="col-md-4"><label label-data="EstCoordinate">经纬度:</label><span></span></div>
						<div class="col-md-4"><label label-data="DisAddress">详细地址:</label><span></span></div>
					</div>
				</div>
			</div>
			<div class="tab_page2">
				<div class="importantInfo col-md-12">
					<div class="title"><span></span>使用单位信息</div>
					<div class="labelData">
						<div class="col-md-4"><label label-data="UseName">产权单位:</label><span></span></div>
						<div class="col-md-4"><label label-data="UseName">使用单位:</label><span></span></div>
						<div class="col-md-4"><label label-data="ProName">物业单位:</label><span></span></div>
						<div class="col-md-4"><label label-data="">使用单位联系地址:</label><span></span></div>
					</div>
				</div>
				<div class="importantInfo col-md-12">
					<div class="title"><span></span>年检信息</div>
					<div class="labelData">
						<div class="col-md-4"><label label-data="EleBeforeDate">上次年检日期:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleInspectionDate">下次年检日期:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleUseCertificate">使用登记证:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleContractCode">合格证号:</label><span></span></div>
						<div class="col-md-4"><label label-data="EleInspection">检验机构:</label><span></span></div>
					</div>
				</div>
				<div class="importantInfo col-md-12">
					<div class="title"><span></span>电梯信息</div>
					<div class="labelData">
						<div class="col-md-4"><label label-data="EleUseStatus">电梯使用状态:</label><span></span></div>
						<div class="col-md-4"><label label-data="UnitName">维保站点名称:</label><span></span></div>
					</div>
				</div>
			</div>
		</div>
	  </div>
	</div>
</div>

<!--维保信息列表模板-->
<script id="tbodyInfo1" type="text/x-handlebars-template">
    {{#each this}}
    <tr>
        <td title="{{EleJobNo}}">{{EleJobNo}}</td>
		<td><a href="#" onclick="mainCountFun('{{EleId}}')">{{MainCount}}</a></td>
        <td title="{{LastMainTimeView}}">{{LastMainTimeView}}</td>
	</tr>
    {{/each}}
</script>

<!--维保信息的弹层-->
<script id="tbodyInfo4" type="text/x-handlebars-template">
	{{#each this}}
	<tr>
		<td>{{MainUnitName}}</td>
		<td>{{EmpName}}</td>
		<td>{{MainCreateTimeView}}</td>
	</tr>
	{{/each}}
</script>
<!--单位维保记录的弹层-->
<script id="tbodyInfo5" type="text/x-handlebars-template">
	{{#each this}}
	<tr>
		<td>{{EleJobNo}}</td>
		<td>{{UseName}}</td>
		<td>{{MainCreateTimeView}}</td>
	</tr>
	{{/each}}
</script>

<!--维保统计列表模板-->
<script id="tbodyInfo3" type="text/x-handlebars-template">
	{{#each this}}
	<tr>
		<td title="{{MainName}}">{{MainName}}</td>
		<td><a href="#" onclick="depCountFun('{{MainId}}','{{EmpId}}')">{{MainsCount}}</a></td>
		<td title="{{EmpName}}">{{EmpName}}</td>
	</tr>
	{{/each}}
</script>


<script>
    var mainInfoUrl=configSet+"/api/events/getmaintenanceinfoforeleInfo?pagesize="+pageSize+"&pagenum=1&loginer="+loginer+"&inquire=";
    var mainCountUrl=configSet+"/api/events/getmaintenanceinfoforemployee?pageNum=1&pageSize="+pageSize+"&loginer="+loginer+"&inquire=&unitId=&empId=";

    //获取维保信息和维保统计数据
    $(function () {
      getTableData(mainInfoUrl);
      getTableData2(mainCountUrl);
    })

	/*维保信息数据获取方法*/
    function getTableData(url) {
        getData(url,function (Obj,pageNum) {
	        tableData(Obj,$('#tbody1'), $("#tbodyInfo1"));
	        pageFun2(pageNum,".tabPages1")
        })
    }	
	
	//维保信息导出
	function exportInfo(){
      window.open(configSet+"/api/events/getmaintenanceinfoForeleinfoexport?inquire="+searchValue+"&loginer="+loginer);
    }

    //维保信息维保次数的点击事件
    function mainCountFun(EleId) {
      var newUrl2=configSet+"/api/events/getmaintenanceinfoforeleInfobyeleid?eleid="+EleId;
      builder.builderSelected(newUrl2,$("#myModal2"),$("#tbody2"),$("#tbodyInfo4"));
    }
    //维保单位维保次数的点击事件
    function depCountFun(unitId,empId) {
      var newUrl2=configSet+"/api/events/getmaindetailinfobyempidandunitid?unitId="+unitId+"&empId="+empId;
      builder.builderSelected(newUrl2,$("#myModal4"),$("#tbody4"),$("#tbodyInfo5"));
    }
	
	//维保信息分页
	$(".tabPages1").on("click","a",function () {
      $(this).parent().addClass("actived").siblings().removeClass("actived");
	  var pagenum=parseInt($(this).text());
	  var mainInfoUrl=configSet+"/api/events/getmaintenanceinfoforeleInfo?pagesize="+pageSize+"&pagenum="+pagenum+"&inquire="+searchValue+"&loginer="+loginer;
	  getData(mainInfoUrl,function (Obj) {
	    var myTemplate = Handlebars.compile($("#tbodyInfo1").html());
	    $('#tbody1').html(myTemplate(JSON.parse(Obj)));
	  })
	})
	
	/*维保统计数据获取方法*/
    function getTableData2(url) {
        getData(url,function (Obj,pageNum) {
	        tableData(Obj,$('#tbody3'), $("#tbodyInfo3"));
	        pageFun2(pageNum,".tabPages3")
        })
    }
    
    //维保统计搜索
	function searchFun3(){
		var formse = $(".form3").serializeObject();
		var mainCountUrl2=configSet+"/api/events/getmaintenanceinfoforemployee?pageNum=1&pageSize="+pageSize+"&inquire=&unitId="+formse['unitId']+"&empId="+formse['empId']+"&loginer="+loginer;
		getTableData2(mainCountUrl2);
	}

	//维保统计导出
	function exportInfo2(){
      var formse = $(".form3").serializeObject();
      window.open(configSet+"/api/file/mainInfoexportforemployee?unitId="+formse['unitId']+"&empId="+formse['empId']+"&loginer="+loginer);
    }

	//维保统计分页
	$(".tabPages3").on("click","a",function () {
      $(this).parent().addClass("actived").siblings().removeClass("actived");
	  var pagenum=parseInt($(this).text());
	  var formse = $(".form3").serializeObject();
	  var mainCountUrl2=configSet+"/api/events/getmaintenanceinfoforemployee?pageNum="+pagenum+"&pageSize="+pageSize+"&inquire=&unitId="+formse['unitId']+"&empId="+formse['empId']+"&loginer="+loginer;
	  getData(mainCountUrl2,function (Obj) {
	    var myTemplate = Handlebars.compile($("#tbodyInfo3").html());
	    $('#tbody3').html(myTemplate(JSON.parse(Obj)));
	  })
	})

    //电梯详情查看
   /* function estCountFun(eleId) {
      $("#myModal3").modal("show");
      var urlP=configSet+"/api/file/getelevatorinfobyid?eleId="+eleId;
      getData(urlP,function (Obj) {
        Obj = JSON.parse(Obj);
        labelData($(".labelData"), Obj);
      })
    }*/
	
	//tab-table切换页
	    $(".tabPage").hide().eq(0).show();
	    $(".nav-tabs>li").click(function(){
	      $(this).addClass("active").siblings().removeClass("active");
	      $(".tabPage").hide().eq($(this).index()).show();
	    })
	    
	//弹框tab切换
	  $(".tab_page2").hide().eq(0).show();
	  $("#myModal3 .nav-tabs>li").click(function(){
		$(this).addClass("active").siblings().removeClass("active");
	    $(".tab_page2").hide().eq($(this).index()).show();
	  })
	
	//获取维保统计下拉框内容
	var maintanceUnitUrl=configSet+"/api/unitmanage/maintenanceunitInfolist?pagesize=999&pagenum=1&inquire";
	var maintancePeopleUrl=configSet+"/api/userinfo/GetList?pagesize="+pageSize+"&pagenum=1&inquire=&empCardType=";
       
    Option(maintanceUnitUrl,$("#maintance1"),"MainName","MainId");
    Option(maintancePeopleUrl,$("#maintancePeople1"),"EmpName","EmpId");
    Option(maintanceUnitUrl,$("#maintance2"),"MainName","MainId");
    Option(maintancePeopleUrl,$("#maintancePeople2"),"EmpName","EmpId");
	
	//日程安排展示
	var op={
			contentHeight: 470,
			header:{
			    left:  'prevYear,prev,next,nextYear today' ,
			    center: 'title',
			    right: 'month,basicWeek,basicDay'
//			    right:  'month,agendaWeek,agendaDay'
			},
			buttonText: {
                today: '本月',
                month: '月',
                week: '周',
                day: '天'
           },
            monthNames: ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"],
            monthNamesShort:["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"],
            dayNames: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
            dayNamesShort: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
            allDayText: "全天",
            weekMode:'variable',
			eventLimit: true,
			handleWindowResize:true,
			eventColor: '#83bff6',
			events: [],
			eventRender:function(event, element) {
			    element.html(event.title);
			}
	  }
	var formse = $("#calendarSearch").serializeObject();
	var calendarUrl=configSet+"/api/events/getmaintenanceinfoforcalendar?unitId="+formse['unitId']+"&empId="+formse['empId']+"&loginer="+loginer;  
	function getDate(url,callback){
		getData(url,function(Obj){
			if (Obj === '暂无数据！'){
				alert(Obj)
		    }else {
		    	var events = [];
		        var Obj = JSON.parse(Obj);
		        Obj.forEach(function(value,index){
		      		var eventsEle = {};
		      		var timeStr = value.MainCreateTime;
		      		eventsEle.title = '电梯名称：'+value.EleJobNo+ '<br/>' +'维保编号：'+value.MainCode+ '<br/>' +'维保人员：'+value.EmpName;
		      		eventsEle.start = value.MainCreateTime;
//		      		eventsEle.start = timeStr.substring(0,timeStr.indexOf("T"));
		      		events[index] = eventsEle;
		        })
		        op.events = events;
				$('#calendar').fullCalendar( 'addEventSource', events );
		    }
		})
	}
	
	//该点击事件为了打开页面就将日历渲染出来
	$(".nav-tabs>li:eq(2)").click(function(){
        getDate(calendarUrl);
        $('#calendar').fullCalendar( 'removeEvents');
      	$('#calendar').fullCalendar(op)	;
    })
	
	//日期搜索
	function calendarSearch(){
		var formse = $("#calendarSearch").serializeObject();
		var calendarUrl=configSet+"/api/events/getmaintenanceinfoforcalendar?unitId="+formse['unitId']+"&empId="+formse['empId']+"&loginer="+loginer;
		$('#calendar').fullCalendar( 'removeEvents');
		getDate(calendarUrl);
		$('#calendar').fullCalendar('refetchEvents')			
	}
</script>
