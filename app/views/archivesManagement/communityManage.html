
<div class="mainwrap">
	<div class="header"><span>档案管理</span>><span>小区管理</span></div>
	<form class="main-choose-list overflowH">
		<!--搜索-->
		<div class="search-wrap">
			<span class="icon-icon_search" ></span><input type="text" class="form-control" placeholder="请输入关键字"/>
		</div>
		<button type="button" class="btn btn-info" onclick="searchFn(url)">查询</button>
		<button type="button" class="btn btn-default" id="addModelShow">添加</button>
	</form>
	<div class="main">
		<!--表格列表-->
		<table class="table table-striped table-hover table-bordered"  align="center">
			<thead>
				<th width="34%">小区名称</th>
				<th width="16%">楼宇数量</th>
				<th width="34%">小区地址</th>
				<th width="16%">操作</th>
			</thead>
			<tbody id="tbody">
				
			</tbody>
		</table>
		<div class="page">
			<div class="pageWrap">
				<ul class="pagination">
					<li class="Previous">
						<span aria-hidden="true">&laquo;</span>
					</li>
					
					<li class="Next">
						<span aria-hidden="true">&raquo;</span>
					</li>
				</ul>
				<span>共0条数据</span>
			</div>
		<!--	<button class="btn btn-info icon-icon_daochu pull-right">  导出</button>-->
		</div>
	</div>
</div>
<!-- 添加/修改 .modal -->
<div class="modal fade" id="addCommunityModel" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content modal-minWidth">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h5 class="modal-title" id="gridSystemModalLabel">添加小区</h5>
			</div>
			<div class="modal-body modelStyle">
				<form id="addForm">
					<div class="row ">
						<div class="col-md-3 child" ><strong>*</strong>小区名称</div>
						<div class="col-md-8"><input name="DisName" class="form-control" type="text" required  message="小区名称" maxlength="50" /></div>
					</div>
					<div class="row ">
						<div class="col-md-3 child"><strong>*</strong>详细地址</div>
						<div class="col-md-8"><input name="DisAddress" class="form-control" type="text" required message="详细地址" maxlength="50"/></div>
					</div>
					<div class="row ">
						<div class="col-md-3 child"><strong>*</strong>小区经纬度</div>
						<div class="col-md-6"><input name="DisCoordinate" class="form-control" type="text" placeholder="请从地图选择" message="小区经纬度"/></div>
						<div class="col-md-3" style="margin-top: 10px;margin-left: -10px;"><a href="#" style="text-decoration: underline;" onclick="getPos()">地图定位</a></div>
					</div>
					<div class="row ">
						<div class="col-md-3 child"></div>

					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
				<button type="button" class="btn btn-info hide" id="addModelBtn">确定</button>
				<button type="button" class="btn btn-info " id="editModelBtn">修改</button>
			</div>
		</div>
	</div>
</div>

<!--查看楼宇弹框-->
<div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModal1Label">
	<div class="modal-dialog" role="document">
		<div class="modal-content modal-width">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h5 class="modal-title" id="myModal1Label">关联楼宇</h5>
			</div>
			<div class="modal-body height450">
				<table class="table table-striped table-hover table-bordered"  align="center">
					<thead>
						<th width="100%">楼宇名称</th>
						<!--<th>详细地址</th>-->
					</thead>
					<tbody id="tbody1">
						
					</tbody>
				</table>
				<button type="button" class="btn btn-info btn-sm pull-right" style="margin-top: 10px" id="addEleModelBtn">添加楼宇</button>
			</div>
		</div>
	</div>
</div>
<!-- 添加楼宇的.modal -->
<div class="modal fade" id="addBuildModel" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content modal-minWidth">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h5 class="modal-title">添加楼宇信息</h5>
			</div>
			<div class="modal-body modelStyle">
				<form id="addBuildForm">
					<div class="row ">
						<div class="col-md-3 child"><strong>*</strong>楼宇名称</div>
						<div class="col-md-8"><input name="EstName" class="form-control" type="text" required maxlength="50"/></div>
					</div>
					<div class="row ">
						<div class="col-md-3 child">楼宇经纬度</div>
						<div class="col-md-6"><input name="EstCoordinate" class="form-control" type="text" placeholder="请从地图选择"/></div>
						<div class="col-md-3 " style="margin-top: 10px;margin-left: -10px;"><a href="#" onclick="getPos()" style="text-decoration: underline;">地图定位</a></div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<label id="prompts"></label>
				<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
				<button type="button" class="btn btn-info" id="addBuildModelBtn">确定</button>
			</div>
		</div>
	</div>
</div>

<!--map弹框-->
<div class="modal fade" id="mapModal" tabindex="-1" role="dialog" aria-labelledby="myModal2Label" >
	<div class="modal-dialog" role="document">
		<div class="modal-content modal-width">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="myModal2Label">选择小区经纬度</h4>
			</div>
			<div class="modal-body" id="map">

			</div>
			<div class="modal-footer">
				<p>小区坐标：<span id="posShow"></span></p>
				<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
				<button type="button" class="btn btn-info" id="sureBtn">确定</button>
			</div>
		</div>
	</div>
</div>

<!--确定删除框-->
<div class="modal fade bs-example-modal-sm" id="conformModel" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
	<div class="modal-dialog modal-sm" role="document">
		<div class="modal-content modal-exWidth">
			<div class="modal-body">
				<p><i class="icon-icon_jc_2_on  lightYellow"></i>您确定要删除么？</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default btn-sm comformQiutBtn" data-dismiss="modal">放弃</button>
				<button type="button" class="btn btn-primary btn-sm comformSureBtn">确定</button>
			</div>
		</div>
	</div>
</div>

<!--楼宇数量的弹层的table-->
<script  id="tbodyInfo1" type="text/x-handlebars-template">
	{{#each this}}
	<tr data-estId="{{EstId}}">
		<td>{{EstName}}</td>
		<!--<td>{{EstAddress}}</td>-->
	</tr>
	{{/each}}
</script>

<!--楼宇的添加弹层的table-->
<!--<script  id="tbodyInfo2" type="text/x-handlebars-template">
	{{#each this}}
	<tr data-estId="{{EstId}}">
		<td> <input type="checkbox"></td>
		<td>{{EstName}}</td>
		<td>{{EstAddress}}</td>
	</tr>
	{{/each}}
</script>-->

<!--获取列表模板-->
<script id="tbodyInfo" type="text/x-handlebars-template">
    {{#each this}}
    <tr>
        <td>{{DisName}}</td>
		<td><a href="#" onclick="estCountFun('{{DisId}}','{{DisCoordinate}}')">{{EstCount}}</a></td>
        <td>{{DisAddress}}</td>
		<td data-disId="{{DisId}}"><i class="icon-icon_edit" onclick="editIconFun(this)" data-target="#addCommunityModel"></i><i class="icon-icon_delete" onclick="deleteIconFun(this)"></i></td>
	</tr>
    {{/each}}
</script>

<script>
	  /*$(document).ready(function(){
	    $('input[type="checkbox"]').iCheck({
	      checkboxClass: 'icheckbox_flat-blue',
	    });
	  });*/

	/*获取列表*/
      var url=configSet+"/api/file/districtinfolist?pagesize="+pageSize+"&pagenum=1&inquire=";
	//楼宇数量的点击请求地址，
	  var url2=configSet+"/api/file/getestateinfolistbyid?disId="
	//获取所有楼层的信息,pagesize给到最大，以加载所有数据
//	  var url3=configSet+"/api/file/estateinfolist?pagesize=100&pagenum=1&inquire";
//	//复选完楼层之后提交地址
//	  var posturl1=configSet+"/api/file/setestfordistrictinfo";
//	  
	//小区的id
	var jMap={
	   disId:"",
	   $tbody1:$("#tbody1"),
	   $tbody2:$("#tbody2"),
	   $myModal1:$("#myModal1"),
	   $myModal2:$("#myModal2")
	}

    $(function () {
      getTableData(url);
    })
	  
    //查看楼宇点击添加跳到楼宇添加界面
	  $("#addEleModelBtn").click(function () {
        $('input[name="EstName"]').val("");
        jMap.$myModal1.modal("hide");
		$("#addBuildModel").modal("show");
		$('input[name="EstCoordinate"]').val(coordiateInfo);
        $("#prompts").html("");
      })
	  //添加楼宇弹框的确定事件
	  $("#addBuildModelBtn").click(function () {
        var value = $.trim($("input[name='EstName']").val());
        if(value == ""){
          $("#prompts").html("*楼宇名称不能为空!");
          return false;
        }else {
          var postdata = configSet+"/api/file/estateinfoadd";
          var formse = $("#addBuildForm").serializeObject();
          formse.EstCreater = loginer;
          formse.EstDisId=jMap.disId;
          postData(postdata, JSON.stringify(formse), function () {
            estCountFun(jMap.disId);
            getTableData(url);
          });
          $("#addBuildModel").modal("hide");
          jMap.$myModal1.modal("show");
          $("#prompts").html("");
		}
      })
	  
	/*数据获取*/
    function getTableData(url) {
      getData(url,function (Obj,pageNum) {
        tableData(Obj,$('#tbody'), $("#tbodyInfo"));
        pageFun(pageNum);
      })
    }

	/*添加数据*/
    $("#addModelShow").click(function () {
      $('#addCommunityModel').modal('show');
      $("#addForm")[0].reset();
	  toggle("add","#addCommunityModel","添加小区信息")
    })

	//模态框的确定点击事件。
    $("#addModelBtn").click(function () {
      	requiredAdd()
    })
 
 	//判断添加必填项是否为空
    function requiredAdd(){
    	for (i=0;i<addForm.length;i++){
	        var ele = addForm.elements[i];
	        var msg = ele.getAttribute('message');
	        var value = $.trim(ele.value) 
	        if(value == ""){ 
	           alert(msg + "不能为空!"); 	           
	           ele.focus();
	           return false; 
	       }
	   }
      var postdata = configSet+"/api/file/districtinfoadd";
      var formse = $("#addForm").serializeObject();
      formse.DisCreater = loginer;
      postData(postdata, JSON.stringify(formse), function () {
          getTableData(url);
      });
      $('#addCommunityModel').modal('hide');
    }
 
    //修改操作
    var disId;
    function editIconFun(obj) {
      disId=$(obj).parent().attr("data-disId");
      var url1=configSet+"/api/file/getdistrictinfobyid?disId="+disId;
      getData(url1,function (Obj) {
        Obj=JSON.parse(Obj);
        var inputs=$("#addForm input[type='text']");
        $("#addCommunityModel").modal("show");
        editInput(Obj,inputs,"1");
        //模态框的修改点击事件。
        toggle("edit","#addCommunityModel","修改小区信息")
      })
    }
    
    //模态框的修改点击事件。
    $("#editModelBtn").click(function () {
        requiredEdit()
    });

	function requiredEdit(){
    	for (i=0;i<addForm.length;i++){
	        var ele = addForm.elements[i];
	        var msg = ele.getAttribute('message');
	        var value = $.trim(ele.value) 
	        if(value == ""){ 
	           alert(msg + "不能为空!"); 
	           addForm.elements[i].focus(); 
	           return false; 
	       }
	    }
	    var posturl=configSet+"/api/file/districtinfoupdate";
	    var formse=$("#addForm").serializeObject();
	    formse.disId=disId;
	    formse.DisUpdater=sessionStorage.username;
	    postData(posturl,JSON.stringify(formse),function () {
	       getTableData(url);
	    });
	    $('#addCommunityModel').modal('hide');
    }

    //删除操作
    function deleteIconFun(obj) {
      disId=$(obj).parent().attr("data-disId");
      $("#conformModel").modal();
    }
    
    //模态框的删除点击事件。
    $(".comformSureBtn").click(function () {
      var url1=configSet+"/api/file/districtinfodelete?disId="+disId+"&DisUpdater="+loginer;
      getData(url1,function (Obj) {
      	if (Obj === "该小区下有楼宇信息，暂不能删除！") {
      		alert(Obj)
      	}
        getTableData(url);
      })
      $("#conformModel").modal("hide");
    })

    //楼宇数量的点击事件
	  var coordiateInfo="";
    function estCountFun(disId,coordate) {
		coordiateInfo=coordate;
      jMap.disId=disId;
      var newUrl2=url2 + disId;
      builder.builderSelected(newUrl2,jMap.$myModal1, jMap.$tbody1,$("#tbodyInfo1"));
    }
	
	//地图选点
	var dataStr="";
	function getPos(){
    	$('#mapModal').modal('show');
    	setTimeout(function(){
    		var openMap = openMaps().map;
    		getPoints(openMap,function(data){
    			$(data).each(function(index,ele){
    				var num=ele.toString();
    				data[index]=num.substring(0, num.indexOf(".") + 5);
    			})
    			dataStr=data.join();
    			$("#posShow").html(dataStr);
    		});
    	},300) 
	 }
	
	//地图弹框确认选择
	$("#sureBtn").on('click',function(){
		$('#mapModal').modal('hide');
		$("input[name='DisCoordinate']").val(dataStr);
      $('input[name="EstCoordinate"]').val(dataStr);
	})
	
	//关闭地图弹框清除地图
	$('#mapModal').on('hidden.bs.modal', function () {
    	$("#map").empty();
    	$("#posShow").html('')
  	})
	
    //分页
    $(".pagination").on("click","a",function () {
      $(this).parent().addClass("actived").siblings().removeClass("actived");
      var pagenum=parseInt($(this).text());
      var url2=configSet+"/api/file/districtinfolist?pagesize="+pageSize+"&pagenum="+pagenum+"&inquire="+searchValue;
      getData(url2,function (Obj) {
        var myTemplate = Handlebars.compile($("#tbodyInfo").html());
        $('#tbody').html(myTemplate(JSON.parse(Obj)));
      })
    })
    
</script>


